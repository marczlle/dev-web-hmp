<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../styles/style.css">
    <link rel="stylesheet" href="../styles/calculadora.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="/assets/salad.png">
    <link rel="icon" type="image/png" href="../public/assets/salad.png">
    
</head>
<body>
    <header class='main-header' data-include="../components/header.html"></header>

    <div class="content">

        <form>
            <div class="search-bar">
                <i class="bi bi-search search-icon"></i>
                <input class="form-control" list="datalistOptions" id="exampleDataList" placeholder="Procure por um alimento...">
                <datalist id="datalistOptions"> <!-- Aqui é o tipo de código que consulta uma tabela toda e preenche tudo nas options -->
                    <option value="Pizza de Pepperoni">
                    <option value="Hambúrguer">
                    <option value="Maçã">
                    <option value="Arroz e Feijão">
                    <option value="Frango Grelhado">
                </datalist>
            </div>
        </form>
        
        <section class="food-name">
            <img class="food-name-image" src="https://www.calorieking.com/food-images/us/d0fbfbe2-db93-42d7-811f-be2a56ec9416.jpg" alt="Pizza de Pepperoni"/>
            <div class="food-text">
                <p>Quantas calorias tem em:</p>
                <h1 id="h1_alimento">Domino's Pizza Pepperoni Large Hand Tossed Crust Pizza</h1> <!-- Consultar o que foi digitado e atualizar aqui -->
            </div>
        </section>
        
        <section class="food-info">
            <div class="nutrition-card">
                <div class="card-top">
                    <h2 id="h2_calories" class="calories">280 Calories</h2> <!-- Consultar o que foi digitado e atualizar aqui -->
                    <div class="serving-controls">
                        <div class="input-group">
                            <input type="number" id="quantity" value="1" min="1">
                            <label for="quantity">Quantidade</label> 
                        </div>
                        <span class="multiplier">x</span>
                        <div class="input-group">
                            <select>
                                <option id="measure">g</option>
                            </select>
                            <label for="measure">Unidade de Medida</label>
                        </div>
                    </div>
                </div>
                <div class="card-bottom"> <!-- Consultar o que foi digitado e atualizar aqui -->
                    <div class="macro">
                        <p class="value">11 g</p>
                        <p class="label">Gordura</p>
                    </div>
                    <div class="macro">
                        <p class="value">32 g</p>
                        <p class="label">Carbs</p>
                    </div>
                    <div class="macro">
                        <p class="value">0.5 g</p>
                        <p class="label">Fibra</p>
                    </div>
                    <div class="macro">
                        <p class="value">11 g</p>
                        <p class="label">Proteína</p>
                    </div>
                </div>
            </div>

            <div class="burn-time">
                <h3>Tempo de Queima de Calorias</h3> <!-- Isso aqui é só uma lógica matemática -->
                <p id="p_calorias">Quanto tempo levaria para queimar 280 calorias?</p>
                
                <div class="activities-grid">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-water"></i> 
                        </div>
                        <div class="activity-info">
                            <span class="activity-name">Natação</span>
                            <span id="natação" class="activity-time">9.6 minutos</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-person-walking"></i>
                        </div>
                        <div class="activity-info">
                            <span class="activity-name">Corrida</span>
                            <span id="corrida" class="activity-time">2 minutos</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-bicycle"></i>
                        </div>
                        <div class="activity-info">
                            <span class="activity-name">Ciclismo</span>
                            <span id="ciclismo" class="activity-time">3 minutos</span>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-person-walking"></i>
                        </div>
                        <div class="activity-info">
                            <span class="activity-name">Caminhada</span>
                            <span id="caminhada" class="activity-time">4 minutos</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="popular-foods-container">
            <h3>Alimentos Populares</h3> <!-- Lógica de digitar o que foi clicado lá na barra de pesquisa -->
            <div class="popular-foods">
                <div class="card">
                    <img src="https://www.dietabiotres.pt/wp-content/uploads/2017/11/Peito-de-frango-grelhados.jpg" class="card-img-top" alt="Coca-Cola">
                    <div class="card-body">
                        <p class="card-text">Frango Grelhado</p>
                    </div>
                </div>

                <div class="card">
                    <img src="https://assets.tmecosys.com/image/upload/t_web_rdp_recipe_584x480/img/recipe/ras/Assets/7F99AEE8-50AA-4CAA-A340-81E4891F912F/Derivates/3de10392-9a13-48e5-9098-af5149c40c0a.jpg" class="card-img-top" alt="Big Mac">
                    <div class="card-body">
                        <p class="card-text">Arroz Integral</p>
                    </div>
                </div>
                
                <div class="card">
                    <img src="https://vitat.com.br/bkt/busca-de-alimentos/1735-ovo-de-galinha-cozido.jpg" class="card-img-top" alt="Sorvete Kibon">
                    <div class="card-body">
                        <p class="card-text">Ovo Cozido</p>
                    </div>
                </div>
                
                <div class="card">
                    <img src="https://cdn.casaeculinaria.com/wp-content/uploads/2023/10/13115444/Salmao-grelhado-1.webp" class="card-img-top" alt="Barra de Chocolate">
                    <div class="card-body">
                        <p class="card-text">Salmão</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <footer class="main-footer" data-include="../components/footer.html"></footer>

    <script src="../scripts/include.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let alimentoAtual = null;

        // Função pra pegar todas as linhas da tabela Alimentos pra por lá na barra de pesquisa
        function obter_alimentos() {
            fetch("http://localhost:5000/alimentos")
            .then(response => response.json())
            .then(data => {
                const datalist = document.getElementById("datalistOptions");
                datalist.innerHTML = ""; // limpa antes de adicionar novos

                data.forEach(alimento => {
                    const option = document.createElement("option");
                    option.value = alimento.nome_alimento;
                    datalist.appendChild(option);
                });
            })
            .catch(error => console.error("Erro ao buscar alimentos:", error));
        }

        // Ao apertar ENTER na barra de pesquisa, essa função é chamada
        // Serve pra buscar o alimento pelo nome que foi colocado na barra de pesquisa
        // E depois Atualizar os conteudos da pagina com base no objeto alimento retornado
        function buscarAlimento(input) {
            fetch(`http://localhost:5000/alimentos/nutrientes/${input}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Alimento não encontrado.');
                }
                return response.json();
            })
            .then(data => {
                alimentoAtual = data;

                const h1_alimento = document.getElementById('h1_alimento');
                const measure = document.getElementById('measure');

                h1_alimento.innerText = data.nome_alimento;
                measure.innerText = data.unidade_padrao;

                // Define a quantidade como 1 antes de atualizar
                document.getElementById('quantity').value = 1;

                // Atualiza tanto as calorias quanto os nutrientes
                atualizarCalorias();
            })
            .catch(error => {
                console.error("Erro ao buscar alimento:", error);
                document.getElementById('h1_alimento').innerText = "Alimento não encontrado";
                document.getElementById('h2_calories').innerText = "0 Calorias";
                document.querySelector('.card-bottom').innerHTML = ""; // Limpa os nutrientes
            });
        }

        function atualizarNutrientes() {
            const cardBottom = document.querySelector('.card-bottom');
            cardBottom.innerHTML = ""; // Limpa os nutrientes antigos

            if (alimentoAtual && alimentoAtual.nutrientes) {
                const quantidade = parseInt(document.getElementById('quantity').value) || 1;

                alimentoAtual.nutrientes.forEach(item => {
                    // Cria o container do macro
                    const macroDiv = document.createElement('div');
                    macroDiv.className = 'macro';

                    // Cria o parágrafo do valor
                    const valueP = document.createElement('p');
                    valueP.className = 'value';
                    const valorCalculado = item.quantidade_por_100un * quantidade;
                    // Formata com uma casa decimal se não for um inteiro
                    const valorFormatado = Number.isInteger(valorCalculado) ? valorCalculado : valorCalculado.toFixed(1);
                    valueP.innerText = `${valorFormatado} ${item.unidade_medida}`;


                    // Cria o parágrafo do rótulo
                    const labelP = document.createElement('p');
                    labelP.className = 'label';
                    labelP.innerText = item.nome_nutriente;

                    // Adiciona os parágrafos ao container do macro
                    macroDiv.appendChild(valueP);
                    macroDiv.appendChild(labelP);

                    // Adiciona o macro ao card
                    cardBottom.appendChild(macroDiv);
                });
            }
        }

        function atualizarCalorias() {
            const quantidade = parseInt(document.getElementById('quantity').value) || 1;
            const h2_calories = document.getElementById('h2_calories');
            const p_calorias = document.getElementById('p_calorias');

            const natação = document.getElementById('natação');
            const corrida = document.getElementById('corrida');
            const ciclismo = document.getElementById('ciclismo');
            const caminhada = document.getElementById('caminhada');

            if (alimentoAtual && !isNaN(quantidade)) {
                const totalCalorias = quantidade * alimentoAtual.calorias;

                // Calorias queimadas por minuto em média
                const caloriasPorMinuto = {
                    natacao: 9.6,
                    corrida: 11.4,
                    ciclismo: 7.5,
                    caminhada: 3.9
                };

                // Tempo necessário = totalCalorias / caloriasPorMinuto
                const tempoNatacao = (totalCalorias / caloriasPorMinuto.natacao).toFixed(1);
                const tempoCorrida = (totalCalorias / caloriasPorMinuto.corrida).toFixed(1);
                const tempoCiclismo = (totalCalorias / caloriasPorMinuto.ciclismo).toFixed(1);
                const tempoCaminhada = (totalCalorias / caloriasPorMinuto.caminhada).toFixed(1);

                h2_calories.innerText = `${totalCalorias} Calorias`;
                p_calorias.innerText = `Quanto tempo levaria para queimar ${totalCalorias} calorias?`;

                natação.innerText = `${tempoNatacao} minutos`;
                corrida.innerText = `${tempoCorrida} minutos`;
                ciclismo.innerText = `${tempoCiclismo} minutos`;
                caminhada.innerText = `${tempoCaminhada} minutos`;
                
                // Chama a função para atualizar os nutrientes
                atualizarNutrientes();
            }
        }

        // Event Listeners ---------------------------------------------------------------------------------

        // Event Listener para quando o DOM (a página) for carregado
        document.addEventListener("DOMContentLoaded", function () {
            // Preenche a lista da barra de pesquisa
            obter_alimentos();

            // *** NOVO CÓDIGO ADICIONADO AQUI ***
            // Adiciona a funcionalidade de clique aos cards de alimentos populares
            const popularFoodCards = document.querySelectorAll('.popular-foods .card');
            popularFoodCards.forEach(card => {
                card.addEventListener('click', () => {
                    // Pega o nome do alimento de dentro do card clicado
                    const foodName = card.querySelector('.card-text').innerText;
                    
                    // Chama a função de busca com esse nome
                    buscarAlimento(foodName);

                    // Opcional: rola a tela para o topo para ver o resultado
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            });
        });

        // Intercepta o envio do formulário (quando pressiona Enter na busca)
        document.querySelector("form").addEventListener("submit", function (event) {
            event.preventDefault(); // Impede o reload da página
            const input = document.getElementById("exampleDataList").value;
            buscarAlimento(input);
        });

        // Monitora quando o usuário aumenta ou diminui a quantidade do alimento
        document.getElementById('quantity').addEventListener('input', atualizarCalorias);

        // Intercepta o envio do formulário (quando pressiona Enter)
        document.querySelector("form").addEventListener("submit", function (event) {
            event.preventDefault(); // Impede o reload da página
            const input = document.getElementById("exampleDataList").value;
            buscarAlimento(input); // Chama sua função personalizada
        });

        // Event Listener pra monitorar quando usuario aumenta ou diminui a quantidade do alimento
        document.getElementById('quantity').addEventListener('input', atualizarCalorias);

    </script>
</body>
</html>